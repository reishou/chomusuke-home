name: Build and Deploy Astro Static Site

on:
  push:
    branches: [ main ]  # Hoặc branch bạn dùng cho production

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'  # Astro khuyến nghị Node 18+ hoặc 20
          cache: 'npm'  # Hoặc yarn/pnpm nếu bạn dùng

      - name: Install dependencies
        run: npm ci  # Hoặc npm install nếu không có lockfile

      - name: Build Astro site
        run: npm run build  # Output sẽ ở dist/

      - name: Deploy with rsync
        uses: easingthemes/ssh-deploy@main  # Action tốt cho rsync static files (2025 vẫn maintain tốt)
        # Hoặc dùng burnett01/rsync-deployments@7.0.1 nếu muốn mới hơn
        with:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          REMOTE_HOST: ${{ secrets.SSH_HOST }}
          REMOTE_USER: ${{ secrets.SSH_USERNAME }}
          REMOTE_PORT: ${{ secrets.SSH_PORT }}
          SOURCE: "dist/"  # Chỉ copy folder build
          TARGET: "/var/www/chomusuke/html"
          ARGS: "-avz --delete"  # -a: archive, -v: verbose, -z: compress, --delete: xóa file cũ không còn
          EXCLUDE: ""
